<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DevNest AI - Your AI Assistant</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Inter', system-ui, sans-serif;
            background: #0f172a;
            color: #e2e8f0;
            min-height: 100vh;
        }
        .mobile-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .message-user {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            border-radius: 18px 18px 4px 18px;
            margin-left: 20%;
            max-width: 90%;
            position: relative;
        }
        .message-ai {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 18px 18px 18px 4px;
            margin-right: 20%;
            max-width: 90%;
            position: relative;
        }
        .typing-indicator span {
            animation: bounce 1.4s infinite ease-in-out both;
        }
        .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce {
            0%, 80%, 100% { 
                transform: scale(0.8);
                opacity: 0.5;
            }
            40% { 
                transform: scale(1);
                opacity: 1;
            }
        }
        .mobile-tab {
            transition: all 0.2s ease;
        }
        .mobile-tab.active {
            background: #374151;
            border-color: #6366f1;
        }
        [x-cloak] { display: none !important; }
        
        .messages-container {
            scroll-behavior: smooth;
        }
        
        /* Message actions */
        .message-actions {
            position: absolute;
            top: 8px;
            right: 8px;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        
        .message-user:hover .message-actions,
        .message-ai:hover .message-actions {
            opacity: 1;
        }
        
        .action-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .action-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }
        
        /* Code block styling */
        .code-block {
            position: relative;
            margin: 8px 0;
        }
        
        .code-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 8px;
            background: #1a202c;
            border-radius: 6px 6px 0 0;
            border: 1px solid #2d3748;
            border-bottom: none;
        }
        
        .code-language {
            font-size: 0.7rem;
            color: #a0aec0;
            font-weight: 500;
        }
        
        .copy-code-btn {
            background: #2d3748;
            border: none;
            border-radius: 4px;
            padding: 2px 8px;
            color: #e2e8f0;
            font-size: 0.7rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .copy-code-btn:hover {
            background: #4a5568;
        }
        
        .copy-code-btn.copied {
            background: #48bb78;
            color: white;
        }
        
        .code-content {
            background: #1a202c;
            border: 1px solid #2d3748;
            border-radius: 0 0 6px 6px;
            padding: 12px;
            overflow-x: auto;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.8rem;
            line-height: 1.4;
        }
        
        /* Real-time typing effect */
        .typing-cursor {
            display: inline-block;
            width: 2px;
            height: 1em;
            background: #e2e8f0;
            margin-left: 2px;
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        
        /* Edit input */
        .edit-input {
            background: transparent;
            border: 1px solid #6366f1;
            border-radius: 8px;
            padding: 8px;
            color: white;
            width: 100%;
            font-family: inherit;
            resize: vertical;
            min-height: 60px;
        }
        
        .edit-actions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }
        
        .edit-btn {
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .edit-confirm {
            background: #6366f1;
            color: white;
            border: none;
        }
        
        .edit-cancel {
            background: transparent;
            color: #a0aec0;
            border: 1px solid #4a5568;
        }
        
        @media (max-width: 768px) {
            .message-user, .message-ai {
                margin-left: 10% !important;
                margin-right: 10% !important;
                max-width: 85% !important;
                padding: 12px !important;
            }
            .mobile-text-sm {
                font-size: 14px !important;
            }
            .mobile-padding {
                padding: 12px !important;
            }
            .mobile-input {
                padding: 12px !important;
                font-size: 16px !important;
            }
            
            .message-actions {
                opacity: 1; /* Always show on mobile */
                position: static;
                display: flex;
                gap: 4px;
                margin-top: 8px;
                justify-content: flex-end;
            }
        }
    </style>
</head>
<body class="bg-slate-900">
    <div x-data="{ 
        activeTab: 'chat',
        loggedIn: false,
        showLoginModal: false,
        username: 'User',
        userEmail: '',
        isLoading: false,
        conversationHistory: []
    }" class="mobile-container">
        
        <!-- Header -->
        <div class="bg-slate-800 border-b border-slate-700 p-4 mobile-padding">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-gradient-to-r from-blue-500 to-purple-600 rounded-xl flex items-center justify-center">
                        <i class="fas fa-brain text-white text-lg"></i>
                    </div>
                    <div>
                        <h1 class="text-lg font-bold text-white mobile-text-sm">DevNest AI</h1>
                        <p class="text-slate-400 text-xs">Your AI Assistant</p>
                    </div>
                </div>
                <div class="flex items-center space-x-2">
                    <template x-if="!loggedIn">
                        <span class="text-xs text-orange-400 bg-orange-400/20 px-2 py-1 rounded">Guest</span>
                    </template>
                    <template x-if="loggedIn">
                        <span class="text-xs text-green-400 bg-green-400/20 px-2 py-1 rounded">
                            <i class="fas fa-user-check mr-1"></i>
                            <span x-text="username"></span>
                        </span>
                    </template>
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="bg-slate-800 border-b border-slate-700 p-2 mobile-padding">
            <div class="flex space-x-1">
                <button 
                    @click="activeTab = 'chat'" 
                    :class="activeTab === 'chat' ? 'mobile-tab active text-white border-blue-500' : 'mobile-tab text-slate-400 border-transparent'"
                    class="flex-1 py-2 px-2 rounded-lg border text-sm font-medium transition mobile-text-sm"
                >
                    <i class="fas fa-comments mr-1"></i> Chat
                </button>
                <button 
                    @click="activeTab = 'history'" 
                    :class="activeTab === 'history' ? 'mobile-tab active text-white border-blue-500' : 'mobile-tab text-slate-400 border-transparent'"
                    class="flex-1 py-2 px-2 rounded-lg border text-sm font-medium transition mobile-text-sm"
                >
                    <i class="fas fa-history mr-1"></i> History
                </button>
                <button 
                    @click="activeTab = 'login'" 
                    :class="activeTab === 'login' ? 'mobile-tab active text-white border-blue-500' : 'mobile-tab text-slate-400 border-transparent'"
                    class="flex-1 py-2 px-2 rounded-lg border text-sm font-medium transition mobile-text-sm"
                >
                    <i class="fas fa-user mr-1"></i> Account
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="flex-1 overflow-hidden">
            <!-- Chat Tab -->
            <template x-if="activeTab === 'chat'">
                <div class="h-full flex flex-col">
                    <!-- Messages Area -->
                    <div id="messages" class="messages-container flex-1 overflow-y-auto p-3 space-y-3 mobile-padding">
                        <!-- Welcome Message -->
                        <div class="message-ai">
                            <div class="flex items-start space-x-2">
                                <div class="w-8 h-8 bg-gradient-to-r from-green-400 to-blue-500 rounded-full flex items-center justify-center flex-shrink-0">
                                    <i class="fas fa-robot text-white text-xs"></i>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <div class="font-semibold text-blue-300 text-sm mb-1">DevNest AI</div>
                                    <div class="text-slate-200 text-sm leading-relaxed">
                                        <template x-if="!loggedIn">
                                            <p class="mb-2">Hello! I'm DevNest AI, your intelligent assistant. I can help you with anything! 🚀</p>
                                        </template>
                                        <template x-if="loggedIn">
                                            <p class="mb-2">Hello <span x-text="username"></span>! 👋 I'm DevNest AI, your intelligent assistant.</p>
                                        </template>
                                        <p class="mb-3">I can help you with:</p>
                                        <ul class="list-disc list-inside space-y-1 text-slate-300 text-xs">
                                            <li>Writing & explaining code</li>
                                            <li>Answering general questions</li>
                                            <li>Creative writing & content</li>
                                            <li>Problem solving & analysis</li>
                                            <li>Learning & research</li>
                                        </ul>
                                        <p class="mt-2 text-xs">Ask me anything! 💫</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div class="p-3 border-t border-slate-700 mobile-padding">
                        <div class="grid grid-cols-2 gap-2 mb-3">
                            <button onclick="quickAction('Explain quantum computing in simple terms')" class="bg-slate-700/50 hover:bg-slate-600 p-2 rounded-lg transition text-xs text-center border border-slate-600">
                                <i class="fas fa-atom text-purple-400 mb-1 block"></i>
                                Science
                            </button>
                            <button onclick="quickAction('Write a creative story about space exploration')" class="bg-slate-700/50 hover:bg-slate-600 p-2 rounded-lg transition text-xs text-center border border-slate-600">
                                <i class="fas fa-pen-fancy text-green-400 mb-1 block"></i>
                                Writing
                            </button>
                            <button onclick="quickAction('Help me plan a healthy meal for the week')" class="bg-slate-700/50 hover:bg-slate-600 p-2 rounded-lg transition text-xs text-center border border-slate-600">
                                <i class="fas fa-utensils text-orange-400 mb-1 block"></i>
                                Lifestyle
                            </button>
                            <button onclick="quickAction('Explain machine learning to a beginner')" class="bg-slate-700/50 hover:bg-slate-600 p-2 rounded-lg transition text-xs text-center border border-slate-600">
                                <i class="fas fa-graduation-cap text-yellow-400 mb-1 block"></i>
                                Learning
                            </button>
                        </div>

                        <!-- Input Area -->
                        <div class="flex space-x-2">
                            <div class="flex-1 relative">
                                <input 
                                    type="text" 
                                    id="messageInput"
                                    placeholder="Ask me anything..."
                                    class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 mobile-input focus:outline-none focus:border-blue-500 text-sm"
                                    onkeypress="handleKeyPress(event)"
                                >
                                <button onclick="sendMessage()" class="absolute right-2 top-1/2 transform -translate-y-1/2 w-8 h-8 bg-gradient-to-r from-blue-500 to-purple-600 rounded-lg flex items-center justify-center hover:scale-110 transition">
                                    <i class="fas fa-paper-plane text-white text-xs"></i>
                                </button>
                            </div>
                        </div>
                        <template x-if="!loggedIn">
                            <p class="text-gray-500 text-xs mt-2 text-center">
                                <i class="fas fa-info-circle mr-1"></i>
                                Chatting as guest - <button @click="activeTab = 'login'" class="text-blue-400 hover:text-blue-300 underline">Sign in</button> to save your history
                            </p>
                        </template>
                    </div>
                </div>
            </template>

            <!-- History Tab -->
            <template x-if="activeTab === 'history'">
                <div class="h-full p-4 mobile-padding">
                    <template x-if="!loggedIn">
                        <div class="text-center h-full flex flex-col items-center justify-center">
                            <i class="fas fa-history text-4xl mb-4 text-slate-500"></i>
                            <h3 class="text-lg font-semibold text-slate-300 mb-2">Chat History</h3>
                            <p class="text-slate-400 text-sm mb-4">Login to save and view your chat history</p>
                            <button 
                                @click="activeTab = 'login'" 
                                class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-lg transition font-medium"
                            >
                                <i class="fas fa-sign-in-alt mr-2"></i>Go to Login
                            </button>
                        </div>
                    </template>
                    <template x-if="loggedIn">
                        <div class="space-y-3">
                            <h3 class="text-lg font-semibold text-white mb-4">Your Conversation History</h3>
                            <div class="bg-slate-800 rounded-lg p-3 border border-slate-700">
                                <div class="font-medium text-white">Science & Technology Discussion</div>
                                <div class="text-slate-400 text-sm">Today - 8 messages</div>
                            </div>
                            <div class="bg-slate-800 rounded-lg p-3 border border-slate-700">
                                <div class="font-medium text-white">Creative Writing Help</div>
                                <div class="text-slate-400 text-sm">Yesterday - 12 messages</div>
                            </div>
                            <div class="bg-slate-800 rounded-lg p-3 border border-slate-700">
                                <div class="font-medium text-white">Learning & Research</div>
                                <div class="text-slate-400 text-sm">2 days ago - 15 messages</div>
                            </div>
                        </div>
                    </template>
                </div>
            </template>

            <!-- Login/Account Tab -->
            <template x-if="activeTab === 'login'">
                <div class="h-full p-4 mobile-padding">
                    <template x-if="!loggedIn">
                        <div class="text-center h-full flex flex-col justify-center">
                            <div class="w-20 h-20 bg-gradient-to-r from-blue-500 to-purple-600 rounded-2xl flex items-center justify-center mx-auto mb-6">
                                <i class="fas fa-user-lock text-white text-2xl"></i>
                            </div>
                            
                            <h3 class="text-xl font-bold text-white mb-2">Welcome to DevNest AI</h3>
                            <p class="text-slate-400 text-sm mb-6">Login to unlock all features</p>

                            <!-- Social Login Buttons -->
                            <div class="space-y-3 mb-4">
                                <button 
                                    onclick="googleLogin()"
                                    class="w-full bg-white hover:bg-gray-100 text-gray-800 font-medium py-3 px-4 rounded-lg border border-gray-300 transition flex items-center justify-center"
                                >
                                    <i class="fab fa-google text-red-500 mr-3"></i>
                                    Continue with Google
                                </button>
                                
                                <button 
                                    onclick="githubLogin()"
                                    class="w-full bg-gray-800 hover:bg-gray-900 text-white font-medium py-3 px-4 rounded-lg border border-gray-700 transition flex items-center justify-center"
                                >
                                    <i class="fab fa-github mr-3"></i>
                                    Continue with GitHub
                                </button>
                            </div>

                            <div class="relative my-6">
                                <div class="absolute inset-0 flex items-center">
                                    <div class="w-full border-t border-slate-600"></div>
                                </div>
                                <div class="relative flex justify-center text-sm">
                                    <span class="px-2 bg-slate-900 text-slate-400">Or continue with email</span>
                                </div>
                            </div>

                            <div class="space-y-4 mb-6">
                                <div>
                                    <label class="block text-sm font-medium text-slate-300 mb-2 text-left">Email</label>
                                    <input type="email" id="emailInput" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-blue-500 mobile-input" placeholder="your@email.com">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-300 mb-2 text-left">Password</label>
                                    <input type="password" id="passwordInput" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-blue-500 mobile-input" placeholder="••••••••">
                                </div>
                            </div>

                            <button 
                                onclick="emailLogin()"
                                class="w-full bg-gradient-to-r from-blue-500 to-purple-600 text-white font-bold py-4 rounded-lg hover:from-blue-600 hover:to-purple-700 transition mb-4"
                            >
                                Sign In
                            </button>

                            <div class="text-center">
                                <button class="text-slate-400 hover:text-white text-sm transition">
                                    Don't have an account? <span class="text-blue-400 hover:text-blue-300" onclick="alert('Use Google/GitHub login or contact admin')">Sign up</span>
                                </button>
                            </div>
                        </div>
                    </template>

                    <template x-if="loggedIn">
                        <div class="space-y-6">
                            <div class="text-center">
                                <div class="w-16 h-16 bg-gradient-to-r from-green-400 to-blue-500 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <i class="fas fa-user-check text-white text-xl"></i>
                                </div>
                                <h3 class="text-xl font-bold text-white" x-text="username"></h3>
                                <p class="text-slate-400 text-sm mt-1" x-text="userEmail"></p>
                                <p class="text-green-400 text-sm mt-2">✓ Logged In</p>
                            </div>

                            <div class="space-y-3">
                                <div class="bg-slate-800 rounded-lg p-4 border border-slate-700">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <div class="font-medium text-white">Account Type</div>
                                            <div class="text-slate-400 text-sm">Free Plan</div>
                                        </div>
                                        <i class="fas fa-crown text-yellow-400"></i>
                                    </div>
                                </div>

                                <div class="bg-slate-800 rounded-lg p-4 border border-slate-700">
                                    <div class="font-medium text-white mb-2">Usage Stats</div>
                                    <div class="text-slate-400 text-sm space-y-1">
                                        <div class="flex justify-between">
                                            <span>Conversations Today:</span>
                                            <span>15</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>Questions Asked:</span>
                                            <span>42</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>Topics Explored:</span>
                                            <span>8</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <button 
                                onclick="logout()"
                                class="w-full bg-red-500/20 hover:bg-red-500/30 text-red-400 border border-red-500/30 py-3 rounded-lg transition font-medium"
                            >
                                <i class="fas fa-sign-out-alt mr-2"></i>Logout
                            </button>
                        </div>
                    </template>
                </div>
            </template>
        </div>
    </div>

    <script>
        // Global variables for conversation management
        let conversationHistory = [];
        let isGenerating = false;
        let currentTypingAnimation = null;

        // Supabase initialization
        let supabase;

        function initSupabase() {
            try {
                const supabaseUrl = 'https://dpkhytntovdupyppkgdc.supabase.co';
                const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRwa2h5dG50b3ZkdXB5cHBrZ2RjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwNTE5NjQsImV4cCI6MjA3MzYyNzk2NH0.nBVRjzj7izsPP3rDt8p7UDclkuHYw4vPSYZ92LkfzHg';
                
                if (typeof window.supabase !== 'undefined') {
                    supabase = window.supabase.createClient(supabaseUrl, supabaseKey, {
                        auth: {
                            persistSession: true,
                            autoRefreshToken: true,
                            detectSessionInUrl: true
                        }
                    });
                    console.log('✅ Supabase initialized with persistence');
                    checkAuthState();
                    setupAuthListener();
                } else {
                    setTimeout(initSupabase, 100);
                }
            } catch (error) {
                console.error('❌ Supabase init error:', error);
            }
        }

        // Check auth state - IMPROVED for login/history issues
        async function checkAuthState() {
            try {
                if (!supabase) {
                    console.log('Supabase not ready yet');
                    return;
                }
                
                const { data: { session }, error } = await supabase.auth.getSession();
                
                if (error) {
                    console.error('Session error:', error);
                    updateUILogout(); // Force logout state on error
                    return;
                }
                
                console.log('🔍 Session check:', session ? 'User logged in' : 'No user');
                
                if (session && session.user) {
                    updateUI(session.user, false);
                } else {
                    updateUILogout();
                }
            } catch (error) {
                console.error('Auth check error:', error);
                updateUILogout(); // Force logout state on error
            }
        }

        // Rest of the Supabase functions remain the same...
        function setupAuthListener() {
            if (!supabase) {
                setTimeout(setupAuthListener, 100);
                return;
            }
            
            const { data: { subscription } } = supabase.auth.onAuthStateChange(async (event, session) => {
                console.log('🔄 Auth state changed:', event);
                
                switch (event) {
                    case 'SIGNED_IN':
                        if (session?.user) {
                            updateUI(session.user, true);
                        }
                        break;
                        
                    case 'SIGNED_OUT':
                        updateUILogout();
                        // Clear all auth data
                        localStorage.removeItem('supabase.auth.token');
                        sessionStorage.clear();
                        break;
                        
                    case 'INITIAL_SESSION':
                        if (session?.user) {
                            updateUI(session.user, false);
                        } else {
                            updateUILogout();
                        }
                        break;
                }
            });
            
            window.authSubscription = subscription;
        }

        async function googleLogin() {
            try {
                if (!supabase) {
                    alert('Please wait, app is still loading...');
                    return;
                }
                
                console.log('🚀 Starting Google login...');
                const { data, error } = await supabase.auth.signInWithOAuth({
                    provider: 'google',
                    options: {
                        redirectTo: window.location.origin,
                        queryParams: {
                            access_type: 'offline',
                            prompt: 'consent'
                        }
                    }
                });
                if (error) throw error;
                console.log('✅ Google login initiated');
            } catch (error) {
                console.error('Google login error:', error);
                alert('Google login failed: ' + error.message);
            }
        }

        async function githubLogin() {
            try {
                if (!supabase) {
                    alert('Please wait, app is still loading...');
                    return;
                }
                
                console.log('🚀 Starting GitHub login...');
                const { data, error } = await supabase.auth.signInWithOAuth({
                    provider: 'github',
                    options: {
                        redirectTo: window.location.origin
                    }
                });
                if (error) throw error;
                console.log('✅ GitHub login initiated');
            } catch (error) {
                console.error('GitHub login error:', error);
                alert('GitHub login failed: ' + error.message);
            }
        }

        async function emailLogin() {
            const email = document.getElementById('emailInput').value;
            const password = document.getElementById('passwordInput').value;
            
            if (!email || !password) {
                alert('Please enter both email and password');
                return;
            }

            try {
                if (!supabase) {
                    alert('Please wait, app is still loading...');
                    return;
                }

                console.log('🚀 Starting email login...');
                const { data, error } = await supabase.auth.signInWithPassword({
                    email: email,
                    password: password
                });
                
                if (error) throw error;
                console.log('✅ Email login successful');
                
            } catch (error) {
                console.error('Email login error:', error);
                alert('Login failed: ' + error.message);
            }
        }

        async function logout() {
            try {
                if (!supabase) return;
                
                console.log('🚪 Logging out...');
                const { error } = await supabase.auth.signOut();
                if (error) throw error;
                
                // Clear all auth data
                localStorage.removeItem('supabase.auth.token');
                sessionStorage.clear();
                updateUILogout();
                
                setTimeout(() => {
                    alert('Logged out successfully!');
                }, 300);
                
            } catch (error) {
                console.error('Logout error:', error);
                alert('Logout failed: ' + error.message);
            }
        }

        function updateUI(user, showAlert = true) {
            console.log('🔄 Updating UI for user:', user?.email);
            
            try {
                const alpineElement = document.querySelector('[x-data]');
                if (alpineElement && alpineElement.__x) {
                    const alpine = alpineElement.__x;
                    
                    alpine.$data.loggedIn = true;
                    alpine.$data.username = user.user_metadata?.name || user.email?.split('@')[0] || 'User';
                    alpine.$data.userEmail = user.email || '';
                    alpine.$data.activeTab = 'chat';
                    
                    console.log('✅ UI Updated - Logged In:', alpine.$data.username);
                    
                    // Force Alpine reactivity
                    Alpine.nextTick(() => {
                        console.log('Alpine reactivity triggered for login');
                    });
                }
                
                if (showAlert) {
                    setTimeout(() => {
                        alert(`🎉 Welcome to DevNest AI, ${user.user_metadata?.name || user.email}!`);
                    }, 500);
                }
                
            } catch (error) {
                console.error('UI update error:', error);
            }
        }

        function updateUILogout() {
            console.log('🔄 Updating UI for logout');
            
            try {
                const alpineElement = document.querySelector('[x-data]');
                if (alpineElement && alpineElement.__x) {
                    const alpine = alpineElement.__x;
                    
                    alpine.$data.loggedIn = false;
                    alpine.$data.username = 'User';
                    alpine.$data.userEmail = '';
                    alpine.$data.activeTab = 'chat';
                    
                    console.log('✅ UI Updated - Logged Out');
                    
                    Alpine.nextTick(() => {
                        console.log('Alpine reactivity triggered for logout');
                    });
                }
            } catch (error) {
                console.error('Logout UI update error:', error);
            }
        }

        // Groq API Configuration
        const GROQ_API_KEY = 'gsk_your_actual_api_key_here';
        const GROQ_API_URL = 'https://api.groq.com/openai/v1/chat/completions';

        // Chat functions with message actions
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        function quickAction(prompt) {
            document.getElementById('messageInput').value = prompt;
            sendMessage();
        }

        async function sendMessage() {
            if (isGenerating) {
                alert('Please wait for the current response to complete...');
                return;
            }

            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message) return;

            input.value = '';
            const messageId = 'msg_' + Date.now();
            addMessage('user', message, messageId);
            
            // Add user message to conversation history
            conversationHistory.push({ role: 'user', content: message });
            
            // Show typing indicator
            const typingElement = showTyping();
            isGenerating = true;

            try {
                // Prepare messages with conversation history
                const recentHistory = conversationHistory.slice(-6);
                const messages = [
                    {
                        role: 'system',
                        content: 'You are DevNest AI, a helpful and intelligent assistant that can help with anything - coding, writing, science, learning, creative tasks, and general knowledge. Be friendly, detailed, and helpful in all your responses. Maintain conversation context.'
                    },
                    ...recentHistory
                ];

                const response = await fetch(GROQ_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${GROQ_API_KEY}`
                    },
                    body: JSON.stringify({
                        model: 'llama3-8b-8192',
                        messages: messages,
                        temperature: 0.7,
                        max_tokens: 1024,
                        stream: false
                    })
                });

                if (!response.ok) {
                    throw new Error(`Groq API error: ${response.status}`);
                }

                const data = await response.json();
                
                if (data.choices && data.choices[0] && data.choices[0].message) {
                    const aiResponse = data.choices[0].message.content;
                    
                    // Add AI response to conversation history
                    conversationHistory.push({ role: 'assistant', content: aiResponse });
                    
                    // Remove typing indicator and show real-time typing
                    hideTyping();
                    await typeMessageRealTime(aiResponse, typingElement);
                    
                } else {
                    throw new Error('Invalid response from Groq API');
                }

            } catch (error) {
                console.error('Groq API error:', error);
                hideTyping();
                
                const fallbackResponse = `I'd be happy to help you with that! 💫\n\nWhether you need explanations, creative writing, problem-solving, or learning help - just let me know what you'd like to explore!`;
                
                // Add fallback to conversation history
                conversationHistory.push({ role: 'assistant', content: fallbackResponse });
                
                hideTyping();
                await typeMessageRealTime(fallbackResponse, typingElement);
            } finally {
                isGenerating = false;
            }
        }

        // Real-time typing effect
        async function typeMessageRealTime(text, typingElement) {
            return new Promise((resolve) => {
                let index = 0;
                const speed = 10;
                const messageId = 'msg_' + Date.now();
                
                // Replace typing indicator with actual message container
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message-ai';
                messageDiv.id = messageId;
                messageDiv.innerHTML = `
                    <div class="flex items-start space-x-2">
                        <div class="w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0 bg-gradient-to-r from-green-400 to-blue-500">
                            <i class="fas fa-robot text-white text-xs"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="font-semibold text-blue-300 text-sm mb-1">DevNest AI</div>
                            <div class="text-slate-200 leading-relaxed text-sm" id="typing-content-${messageId}"></div>
                        </div>
                    </div>
                    <div class="message-actions">
                        <button class="action-btn" onclick="copyMessage('${messageId}')" title="Copy">
                            <i class="fas fa-copy text-xs"></i>
                        </button>
                    </div>
                `;
                
                typingElement.replaceWith(messageDiv);
                const contentElement = document.getElementById(`typing-content-${messageId}`);
                
                function typeCharacter() {
                    if (index < text.length) {
                        const currentText = text.substring(0, index + 1);
                        contentElement.innerHTML = formatMessage(currentText) + '<span class="typing-cursor"></span>';
                        
                        index++;
                        
                        smoothScrollToBottom();
                        setTimeout(typeCharacter, speed);
                    } else {
                        contentElement.innerHTML = formatMessage(text);
                        smoothScrollToBottom();
                        resolve();
                    }
                }
                
                typeCharacter();
            });
        }

        function addMessage(sender, text, messageId = null) {
            const container = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            const id = messageId || 'msg_' + Date.now();
            
            messageDiv.className = sender === 'user' ? 'message-user' : 'message-ai';
            messageDiv.id = id;
            messageDiv.innerHTML = `
                <div class="flex items-start space-x-2">
                    <div class="w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0 ${
                        sender === 'user' ? 'bg-gradient-to-r from-purple-500 to-pink-500' : 'bg-gradient-to-r from-green-400 to-blue-500'
                    }">
                        <i class="fas ${sender === 'user' ? 'fa-user' : 'fa-robot'} text-white text-xs"></i>
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="font-semibold mb-1 ${sender === 'user' ? 'text-purple-300' : 'text-blue-300'} text-sm">${sender === 'user' ? 'You' : 'DevNest AI'}</div>
                        <div class="text-slate-200 leading-relaxed whitespace-pre-wrap text-sm">${formatMessage(text)}</div>
                    </div>
                </div>
                <div class="message-actions">
                    ${sender === 'user' ? `
                        <button class="action-btn" onclick="editMessage('${id}')" title="Edit">
                            <i class="fas fa-edit text-xs"></i>
                        </button>
                    ` : ''}
                    <button class="action-btn" onclick="copyMessage('${id}')" title="Copy">
                        <i class="fas fa-copy text-xs"></i>
                    </button>
                </div>
            `;
            
            container.appendChild(messageDiv);
            smoothScrollToBottom();
        }

        // Format message with code blocks
        function formatMessage(content) {
            // Handle code blocks with copy functionality
            let formatted = content.replace(/\`\`\`(\w+)?\n([^]+?)\n\`\`\`/g, function(match, language, code) {
                const lang = language || 'text';
                const codeId = 'code_' + Date.now() + Math.random().toString(36).substr(2, 9);
                return `
                    <div class="code-block">
                        <div class="code-header">
                            <span class="code-language">${lang}</span>
                            <button class="copy-code-btn" onclick="copyCode('${codeId}')" data-code="${codeId}">Copy</button>
                        </div>
                        <div class="code-content">
                            <pre><code id="${codeId}">${code.trim()}</code></pre>
                        </div>
                    </div>
                `;
            });
            
            // Handle inline code
            formatted = formatted.replace(/\`([^\`]+)\`/g, '<code class="bg-slate-700 px-1.5 py-0.5 rounded text-xs border border-slate-600 text-green-300">$1</code>');
            
            // Handle bold text
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong class="font-semibold">$1</strong>');
            
            // Handle line breaks
            formatted = formatted.replace(/\n/g, '<br>');
            
            return formatted;
        }

        // Copy message text
        function copyMessage(messageId) {
            const messageElement = document.getElementById(messageId);
            if (messageElement) {
                const contentElement = messageElement.querySelector('.text-slate-200');
                if (contentElement) {
                    const text = contentElement.textContent || contentElement.innerText;
                    navigator.clipboard.writeText(text).then(() => {
                        showToast('Message copied to clipboard!');
                    }).catch(err => {
                        console.error('Failed to copy: ', err);
                        showToast('Failed to copy message');
                    });
                }
            }
        }

        // Copy code from code blocks
        function copyCode(codeId) {
            const codeElement = document.getElementById(codeId);
            const copyButton = document.querySelector(`[data-code="${codeId}"]`);
            
            if (codeElement && copyButton) {
                const text = codeElement.textContent;
                navigator.clipboard.writeText(text).then(() => {
                    copyButton.textContent = 'Copied!';
                    copyButton.classList.add('copied');
                    setTimeout(() => {
                        copyButton.textContent = 'Copy';
                        copyButton.classList.remove('copied');
                    }, 2000);
                }).catch(err => {
                    console.error('Failed to copy code: ', err);
                    showToast('Failed to copy code');
                });
            }
        }

        // Edit message
        function editMessage(messageId) {
            const messageElement = document.getElementById(messageId);
            if (messageElement) {
                const contentElement = messageElement.querySelector('.text-slate-200');
                const originalText = contentElement.textContent || contentElement.innerText;
                
                const editHtml = `
                    <textarea class="edit-input">${originalText}</textarea>
                    <div class="edit-actions">
                        <button class="edit-btn edit-confirm" onclick="confirmEdit('${messageId}')">Send</button>
                        <button class="edit-btn edit-cancel" onclick="cancelEdit('${messageId}')">Cancel</button>
                    </div>
                `;
                
                contentElement.innerHTML = editHtml;
                
                // Focus on textarea
                const textarea = contentElement.querySelector('.edit-input');
                textarea.focus();
                textarea.setSelectionRange(textarea.value.length, textarea.value.length);
            }
        }

        function confirmEdit(messageId) {
            const messageElement = document.getElementById(messageId);
            if (messageElement) {
                const textarea = messageElement.querySelector('.edit-input');
                const newText = textarea.value.trim();
                
                if (newText) {
                    // Update message display
                    const contentElement = messageElement.querySelector('.text-slate-200');
                    contentElement.innerHTML = formatMessage(newText);
                    
                    // Update conversation history
                    const messageIndex = conversationHistory.findIndex(msg => 
                        msg.role === 'user' && messageElement.textContent.includes(msg.content)
                    );
                    
                    if (messageIndex !== -1) {
                        conversationHistory[messageIndex].content = newText;
                    }
                    
                    showToast('Message updated');
                }
            }
        }

        function cancelEdit(messageId) {
            const messageElement = document.getElementById(messageId);
            if (messageElement) {
                const contentElement = messageElement.querySelector('.text-slate-200');
                const originalText = conversationHistory.find(msg => 
                    msg.role === 'user' && messageElement.textContent.includes(msg.content)
                )?.content || '';
                
                contentElement.innerHTML = formatMessage(originalText);
            }
        }

        // Toast notification
        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'fixed bottom-4 left-1/2 transform -translate-x-1/2 bg-slate-800 text-white px-4 py-2 rounded-lg shadow-lg z-50';
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 2000);
        }

        function showTyping() {
            const container = document.getElementById('messages');
            const typingDiv = document.createElement('div');
            typingDiv.id = 'typingIndicator';
            typingDiv.className = 'message-ai';
            typingDiv.innerHTML = `
                <div class="flex items-start space-x-2">
                    <div class="w-8 h-8 rounded-full flex items-center justify-center bg-gradient-to-r from-green-400 to-blue-500">
                        <i class="fas fa-robot text-white text-xs"></i>
                    </div>
                    <div>
                        <div class="font-semibold text-blue-300 text-sm mb-1">DevNest AI</div>
                        <div class="typing-indicator flex space-x-1">
                            <span class="w-1.5 h-1.5 bg-slate-400 rounded-full"></span>
                            <span class="w-1.5 h-1.5 bg-slate-400 rounded-full"></span>
                            <span class="w-1.5 h-1.5 bg-slate-400 rounded-full"></span>
                        </div>
                    </div>
                </div>
            `;
            container.appendChild(typingDiv);
            smoothScrollToBottom();
            return typingDiv;
        }

        function hideTyping() {
            const typing = document.getElementById('typingIndicator');
            if (typing) typing.remove();
        }

        // Smooth scroll to bottom function
        function smoothScrollToBottom() {
            const container = document.getElementById('messages');
            if (container) {
                container.scrollTo({
                    top: container.scrollHeight,
                    behavior: 'smooth'
                });
            }
        }

        // Page load initialization
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Page loaded, initializing...');
            initSupabase();
            
            setTimeout(() => {
                const input = document.getElementById('messageInput');
                if (input) input.focus();
            }, 1500);
        });

        // Cleanup
        window.addEventListener('beforeunload', function() {
            if (window.authSubscription) {
                window.authSubscription.unsubscribe();
            }
        });
    </script>
</body>
</html>