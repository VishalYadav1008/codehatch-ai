<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DevNest AI - Coding Assistant</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0f0f0f;
            color: #ffffff;
            min-height: 100vh;
        }
        .deepseek-style {
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
        }
        .message-user {
            background: #2563eb;
            color: white;
            border-radius: 18px 18px 4px 18px;
            margin-left: 20%;
            max-width: 80%;
        }
        .message-ai {
            background: #374151;
            color: #f3f4f6;
            border-radius: 18px 18px 18px 4px;
            margin-right: 20%;
            max-width: 80%;
            border: 1px solid #4b5563;
        }
        .typing-indicator span {
            animation: bounce 1.4s infinite ease-in-out both;
        }
        .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }
        .btn-primary {
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
            transition: all 0.2s ease;
        }
        .btn-primary:hover {
            background: linear-gradient(135deg, #1d4ed8, #1e40af);
            transform: translateY(-1px);
        }
        .btn-secondary {
            background: #374151;
            border: 1px solid #4b5563;
            transition: all 0.2s ease;
        }
        .btn-secondary:hover {
            background: #4b5563;
            border-color: #6b7280;
        }
        .login-container {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
    </style>
</head>
<body class="deepseek-style">
    <div x-data="{ 
        activeTab: 'chat',
        loggedIn: false,
        username: 'Developer',
        userEmail: '',
        isLoading: false
    }" class="h-screen flex flex-col">
        
        <!-- Header -->
        <div class="bg-gray-900 border-b border-gray-700 px-4 py-3">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="w-8 h-8 bg-blue-500 rounded-lg flex items-center justify-center">
                        <i class="fas fa-code text-white text-sm"></i>
                    </div>
                    <div>
                        <h1 class="text-lg font-semibold text-white">DevNest AI</h1>
                        <p class="text-gray-400 text-xs">Your Coding Assistant</p>
                    </div>
                </div>
                <div class="flex items-center space-x-2">
                    <template x-if="!loggedIn">
                        <div class="flex items-center space-x-3">
                            <span class="text-xs text-orange-400 bg-orange-400/20 px-2 py-1 rounded">
                                <i class="fas fa-user mr-1"></i>Guest
                            </span>
                            <button @click="activeTab = 'signin'" class="text-xs bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded transition">
                                <i class="fas fa-sign-in-alt mr-1"></i>Sign In
                            </button>
                        </div>
                    </template>
                    <template x-if="loggedIn">
                        <div class="flex items-center space-x-3">
                            <span class="text-xs text-green-400 bg-green-400/20 px-2 py-1 rounded">
                                <i class="fas fa-user-check mr-1"></i>
                                <span x-text="username"></span>
                            </span>
                            <button @click="activeTab = 'history'" class="text-xs bg-gray-600 hover:bg-gray-700 text-white px-2 py-1 rounded transition">
                                <i class="fas fa-history mr-1"></i>History
                            </button>
                        </div>
                    </template>
                </div>
            </div>
        </div>

        <!-- Tabs - Always show Chat, History only when logged in, Sign In only when not logged in -->
        <div class="bg-gray-800 border-b border-gray-700 px-4 py-2">
            <div class="flex space-x-1">
                <!-- Chat Tab - Always Visible -->
                <button @click="activeTab = 'chat'" 
                    :class="activeTab === 'chat' ? 'bg-gray-700 text-white' : 'text-gray-400 hover:text-white'"
                    class="flex-1 py-2 px-3 rounded-lg text-sm font-medium transition">
                    <i class="fas fa-comment mr-2"></i>Chat
                </button>
                
                <!-- History Tab - Only when logged in -->
                <template x-if="loggedIn">
                    <button @click="activeTab = 'history'" 
                        :class="activeTab === 'history' ? 'bg-gray-700 text-white' : 'text-gray-400 hover:text-white'"
                        class="flex-1 py-2 px-3 rounded-lg text-sm font-medium transition">
                        <i class="fas fa-history mr-2"></i>History
                    </button>
                </template>
                
                <!-- Sign In Tab - Only when NOT logged in -->
                <template x-if="!loggedIn">
                    <button @click="activeTab = 'signin'" 
                        :class="activeTab === 'signin' ? 'bg-gray-700 text-white' : 'text-gray-400 hover:text-white'"
                        class="flex-1 py-2 px-3 rounded-lg text-sm font-medium transition">
                        <i class="fas fa-sign-in-alt mr-2"></i>Sign In
                    </button>
                </template>
            </div>
        </div>

        <!-- Main Content -->
        <div class="flex-1 overflow-hidden">
            
            <!-- Chat Tab - Available for both Guest and Logged In Users -->
            <template x-if="activeTab === 'chat'">
                <div class="h-full flex flex-col">
                    <!-- Messages -->
                    <div id="messages" class="flex-1 overflow-y-auto p-4 space-y-4">
                        <div class="message-ai p-4">
                            <div class="flex items-start space-x-3">
                                <div class="w-8 h-8 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center flex-shrink-0">
                                    <i class="fas fa-robot text-white text-xs"></i>
                                </div>
                                <div class="flex-1">
                                    <div class="font-semibold text-blue-300 text-sm mb-2">DevNest AI</div>
                                    <div class="text-gray-200 text-sm leading-relaxed">
                                        <template x-if="!loggedIn">
                                            <p class="mb-2">Hello! 👋 I'm DevNest AI, your coding assistant.</p>
                                        </template>
                                        <template x-if="loggedIn">
                                            <p class="mb-2">Hello <span x-text="username"></span>! 👋 I'm DevNest AI, your coding assistant.</p>
                                        </template>
                                        <p class="mb-3">I can help you with:</p>
                                        <ul class="list-disc list-inside space-y-1 text-gray-300 text-xs">
                                            <li>Writing and debugging code in multiple languages</li>
                                            <li>Explaining programming concepts</li>
                                            <li>Code optimization and best practices</li>
                                            <li>Project architecture and design patterns</li>
                                        </ul>
                                        <template x-if="!loggedIn">
                                            <p class="mt-3 text-blue-300 text-sm">
                                                <i class="fas fa-info-circle mr-1"></i>
                                                Sign in to save your chat history and get personalized responses
                                            </p>
                                        </template>
                                        <template x-if="loggedIn">
                                            <p class="mt-3 text-blue-300 text-sm">What would you like to build or learn today?</p>
                                        </template>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Input Area - Available for both Guest and Logged In -->
                    <div class="border-t border-gray-700 p-4">
                        <div class="flex space-x-3">
                            <div class="flex-1 relative">
                                <input type="text" id="messageInput" placeholder="Ask me anything about coding..."
                                    class="w-full bg-gray-700 border border-gray-600 rounded-xl px-4 py-3 text-white placeholder-gray-400 focus:outline-none focus:border-blue-500 text-sm">
                                <button onclick="sendMessage()" class="absolute right-2 top-1/2 transform -translate-y-1/2 w-8 h-8 bg-blue-500 rounded-lg flex items-center justify-center hover:bg-blue-600 transition">
                                    <i class="fas fa-paper-plane text-white text-xs"></i>
                                </button>
                            </div>
                        </div>
                        <template x-if="!loggedIn">
                            <p class="text-gray-500 text-xs mt-2 text-center">
                                <i class="fas fa-info-circle mr-1"></i>
                                Chatting as guest - <button @click="activeTab = 'signin'" class="text-blue-400 hover:text-blue-300 underline">Sign in</button> to save your history
                            </p>
                        </template>
                    </div>
                </div>
            </template>

            <!-- History Tab - Only visible when logged in -->
            <template x-if="activeTab === 'history' && loggedIn">
                <div class="h-full p-6">
                    <div class="space-y-4">
                        <h3 class="text-lg font-semibold text-white mb-4">Your Conversation History</h3>
                        
                        <div class="bg-gray-800 rounded-lg p-4 border border-gray-700 hover:border-blue-500 transition cursor-pointer">
                            <div class="flex justify-between items-start">
                                <div>
                                    <div class="font-medium text-white">React Components & State Management</div>
                                    <div class="text-gray-400 text-sm mt-1">Today • 12 messages</div>
                                </div>
                                <button class="text-blue-400 hover:text-blue-300 text-sm">
                                    <i class="fas fa-arrow-right"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="bg-gray-800 rounded-lg p-4 border border-gray-700 hover:border-blue-500 transition cursor-pointer">
                            <div class="flex justify-between items-start">
                                <div>
                                    <div class="font-medium text-white">Python API Development Guide</div>
                                    <div class="text-gray-400 text-sm mt-1">Yesterday • 8 messages</div>
                                </div>
                                <button class="text-blue-400 hover:text-blue-300 text-sm">
                                    <i class="fas fa-arrow-right"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="bg-gray-800 rounded-lg p-4 border border-gray-700 hover:border-blue-500 transition cursor-pointer">
                            <div class="flex justify-between items-start">
                                <div>
                                    <div class="font-medium text-white">Database Design Patterns</div>
                                    <div class="text-gray-400 text-sm mt-1">2 days ago • 15 messages</div>
                                </div>
                                <button class="text-blue-400 hover:text-blue-300 text-sm">
                                    <i class="fas fa-arrow-right"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </template>

            <!-- Sign In Tab - Only visible when NOT logged in -->
            <template x-if="activeTab === 'signin' && !loggedIn">
                <div class="h-full p-6">
                    <div class="text-center h-full flex flex-col justify-center max-w-sm mx-auto">
                        <div class="login-container rounded-2xl p-8">
                            <div class="w-16 h-16 bg-gradient-to-r from-blue-500 to-purple-600 rounded-2xl flex items-center justify-center mx-auto mb-6">
                                <i class="fas fa-robot text-white text-xl"></i>
                            </div>
                            
                            <h2 class="text-2xl font-bold text-white mb-2">Sign In to DevNest AI</h2>
                            <p class="text-gray-400 text-sm mb-8">Unlock chat history and personalized experience</p>

                            <!-- Login Buttons -->
                            <div class="space-y-3">
                                <button onclick="handleGoogleLogin()" class="btn-primary w-full py-3 rounded-lg font-medium flex items-center justify-center">
                                    <i class="fab fa-google mr-3"></i>Continue with Google
                                </button>
                                
                                <button onclick="handleGithubLogin()" class="btn-secondary w-full py-3 rounded-lg font-medium flex items-center justify-center text-white">
                                    <i class="fab fa-github mr-3"></i>Continue with GitHub
                                </button>
                            </div>

                            <div class="mt-6 p-4 bg-blue-500/10 border border-blue-500/20 rounded-lg">
                                <h4 class="text-blue-300 text-sm font-medium mb-2">
                                    <i class="fas fa-crown mr-2"></i>
                                    Benefits of signing in:
                                </h4>
                                <ul class="text-blue-300/80 text-xs space-y-1 text-left">
                                    <li>• Save your chat history permanently</li>
                                    <li>• Access your conversations across devices</li>
                                    <li>• Get personalized coding recommendations</li>
                                    <li>• Sync your preferences and settings</li>
                                </ul>
                            </div>

                            <div class="mt-6">
                                <button @click="activeTab = 'chat'" class="text-gray-400 hover:text-white text-sm transition">
                                    <i class="fas fa-arrow-left mr-2"></i>Continue as guest
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </template>

            <!-- History Access Prompt - When guest tries to access history -->
            <template x-if="activeTab === 'history' && !loggedIn">
                <div class="h-full flex items-center justify-center p-6">
                    <div class="text-center max-w-md">
                        <div class="w-20 h-20 bg-gradient-to-r from-orange-500 to-red-500 rounded-2xl flex items-center justify-center mx-auto mb-6">
                            <i class="fas fa-lock text-white text-2xl"></i>
                        </div>
                        <h2 class="text-2xl font-bold text-white mb-2">History Locked</h2>
                        <p class="text-gray-400 text-sm mb-6">Sign in to access your chat history and save your conversations</p>
                        <button @click="activeTab = 'signin'" class="btn-primary px-8 py-3 rounded-lg text-white font-medium">
                            <i class="fas fa-sign-in-alt mr-2"></i>Sign In to Unlock
                        </button>
                        <p class="text-gray-500 text-xs mt-4">
                            Or <button @click="activeTab = 'chat'" class="text-blue-400 hover:text-blue-300 underline">continue chatting as guest</button>
                        </p>
                    </div>
                </div>
            </template>
        </div>

        <!-- Loading Overlay -->
        <template x-if="isLoading">
            <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                <div class="bg-gray-800 rounded-lg p-6 flex items-center space-x-3">
                    <div class="w-6 h-6 border-2 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
                    <span class="text-white">Signing in...</span>
                </div>
            </div>
        </template>
    </div>

    <script>
        // Supabase Configuration
        const supabaseUrl = 'https://dpkhytntovdupyppkgdc.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRwa2h5dG50b3ZkdXB5cHBrZ2RjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwNTE5NjQsImV4cCI6MjA3MzYyNzk2NH0.nBVRjzj7izsPP3rDt8p7UDclkuHYw4vPSYZ92LkfzHg';
        
        let supabase;

        // Initialize Supabase
        function initSupabase() {
            try {
                if (typeof window.supabase !== 'undefined') {
                    supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
                    console.log('✅ Supabase initialized');
                    checkAuthState();
                    setupAuthListener();
                } else {
                    setTimeout(initSupabase, 100);
                }
            } catch (error) {
                console.error('❌ Supabase init error:', error);
            }
        }

        // Check authentication state
        async function checkAuthState() {
            try {
                const { data: { session } } = await supabase.auth.getSession();
                if (session && session.user) {
                    updateUI(session.user, false);
                }
            } catch (error) {
                console.error('Auth check error:', error);
            }
        }

        // Google Login
        async function handleGoogleLogin() {
            try {
                showLoading(true);
                const { data, error } = await supabase.auth.signInWithOAuth({
                    provider: 'google',
                    options: {
                        redirectTo: 'https://devnest-ai.vercel.app'
                    }
                });
                if (error) throw error;
            } catch (error) {
                console.error('Google login error:', error);
                alert('Google login failed: ' + error.message);
                showLoading(false);
            }
        }

        // GitHub Login
        async function handleGithubLogin() {
            try {
                showLoading(true);
                const { data, error } = await supabase.auth.signInWithOAuth({
                    provider: 'github',
                    options: {
                        redirectTo: 'https://devnest-ai.vercel.app'
                    }
                });
                if (error) throw error;
            } catch (error) {
                console.error('GitHub login error:', error);
                alert('GitHub login failed: ' + error.message);
                showLoading(false);
            }
        }

        // Update UI after auth changes
        function updateUI(user, showAlert = true) {
            const alpine = document.querySelector('[x-data]').__x;
            if (alpine) {
                alpine.$data.loggedIn = true;
                alpine.$data.username = user.user_metadata?.name || user.email?.split('@')[0] || 'User';
                alpine.$data.userEmail = user.email || '';
                alpine.$data.activeTab = 'chat'; // Auto switch to chat after login
                alpine.$data.isLoading = false;
                
                if (showAlert) {
                    setTimeout(() => {
                        alert(`🎉 Welcome to DevNest AI, ${alpine.$data.username}! You can now access your chat history.`);
                    }, 500);
                }
            }
        }

        // Auth state listener
        function setupAuthListener() {
            supabase.auth.onAuthStateChange((event, session) => {
                console.log('Auth event:', event);
                
                if (event === 'SIGNED_IN' && session?.user) {
                    updateUI(session.user, true);
                } else if (event === 'INITIAL_SESSION' && session?.user) {
                    updateUI(session.user, false);
                }
            });
        }

        // Loading state
        function showLoading(show) {
            const alpine = document.querySelector('[x-data]').__x;
            if (alpine) {
                alpine.$data.isLoading = show;
            }
        }

        // Chat functionality - Available for both Guest and Logged In users
        function handleKeyPress(e) {
            if (e.key === 'Enter') sendMessage();
        }

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            if (!message) return;

            input.value = '';
            addMessage('user', message);
            showTyping();

            // Simulate AI response
            setTimeout(() => {
                hideTyping();
                const responses = [
                    "I can help you with that! Here's how you can approach this...",
                    "Great question! Let me break this down for you with some code examples.",
                    "I understand what you're looking for. Here's a solution that might help:",
                    "That's an interesting coding challenge. Here's my approach to solving it:",
                    "I'd be happy to help with that! Here are some best practices and code snippets:"
                ];
                const response = responses[Math.floor(Math.random() * responses.length)];
                addMessage('ai', response);
            }, 2000);
        }

        function addMessage(sender, text) {
            const container = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = sender === 'user' ? 'message-user p-4' : 'message-ai p-4';
            messageDiv.innerHTML = `
                <div class="flex items-start space-x-3">
                    <div class="w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0 ${sender === 'user' ? 'bg-blue-500' : 'bg-gradient-to-r from-blue-500 to-purple-600'}">
                        <i class="fas ${sender === 'user' ? 'fa-user' : 'fa-robot'} text-white text-xs"></i>
                    </div>
                    <div class="flex-1">
                        <div class="font-semibold ${sender === 'user' ? 'text-blue-200' : 'text-blue-300'} text-sm mb-1">
                            ${sender === 'user' ? 'You' : 'DevNest AI'}
                        </div>
                        <div class="text-gray-200 text-sm leading-relaxed">${text}</div>
                    </div>
                </div>
            `;
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }

        function showTyping() {
            const container = document.getElementById('messages');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message-ai p-4';
            typingDiv.innerHTML = `
                <div class="flex items-start space-x-3">
                    <div class="w-8 h-8 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center">
                        <i class="fas fa-robot text-white text-xs"></i>
                    </div>
                    <div>
                        <div class="font-semibold text-blue-300 text-sm mb-2">DevNest AI</div>
                        <div class="typing-indicator flex space-x-1">
                            <span class="w-2 h-2 bg-gray-400 rounded-full"></span>
                            <span class="w-2 h-2 bg-gray-400 rounded-full"></span>
                            <span class="w-2 h-2 bg-gray-400 rounded-full"></span>
                        </div>
                    </div>
                </div>
            `;
            container.appendChild(typingDiv);
            container.scrollTop = container.scrollHeight;
        }

        function hideTyping() {
            const typing = document.querySelector('.typing-indicator')?.closest('.message-ai');
            if (typing) typing.remove();
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            initSupabase();
            
            // Auto-focus on input
            setTimeout(() => {
                const input = document.getElementById('messageInput');
                if (input) input.focus();
            }, 1000);
        });

        // Handle Enter key in chat
        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                const input = document.getElementById('messageInput');
                if (document.activeElement === input) {
                    sendMessage();
                }
            }
        });
    </script>
</body>
</html>