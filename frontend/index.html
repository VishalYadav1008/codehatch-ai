<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CodeHatch AI - Universal Assistant</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <!-- Supabase CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Inter', system-ui, sans-serif;
            background: #0f172a;
            color: #e2e8f0;
            min-height: 100vh;
        }
        .mobile-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .message-user {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            border-radius: 18px 18px 4px 18px;
            margin-left: 20%;
            max-width: 90%;
        }
        .message-ai {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 18px 18px 18px 4px;
            margin-right: 20%;
            max-width: 90%;
        }
        .typing-indicator span {
            animation: bounce 1.4s infinite ease-in-out both;
        }
        .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce {
            0%, 80%, 100% { 
                transform: scale(0.8);
                opacity: 0.5;
            }
            40% { 
                transform: scale(1);
                opacity: 1;
            }
        }
        .mobile-tab {
            transition: all 0.2s ease;
        }
        .mobile-tab.active {
            background: #374151;
            border-color: #6366f1;
        }
        [x-cloak] { display: none !important; }
        
        /* Smooth scrolling */
        .messages-container {
            scroll-behavior: smooth;
        }
        
        /* Typewriter effect */
        .typewriter {
            overflow: hidden;
            border-right: 2px solid #3b82f6;
            white-space: pre-wrap;
            animation: blink-caret 1s infinite;
        }
        @keyframes blink-caret {
            from, to { border-color: transparent }
            50% { border-color: #3b82f6; }
        }
        
        /* Mobile First Design */
        @media (max-width: 768px) {
            .message-user, .message-ai {
                margin-left: 10% !important;
                margin-right: 10% !important;
                max-width: 85% !important;
                padding: 12px !important;
            }
            .mobile-text-sm {
                font-size: 14px !important;
            }
            .mobile-padding {
                padding: 12px !important;
            }
            .mobile-input {
                padding: 12px !important;
                font-size: 16px !important;
            }
        }
    </style>
</head>
<body class="bg-slate-900">
    <div x-data="{ 
        activeTab: 'chat',
        loggedIn: false,
        showLoginModal: false,
        username: 'User',
        userEmail: ''
    }" class="mobile-container">
        
        <!-- Header - Mobile Optimized -->
        <div class="bg-slate-800 border-b border-slate-700 p-4 mobile-padding">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-gradient-to-r from-blue-500 to-purple-600 rounded-xl flex items-center justify-center">
                        <i class="fas fa-brain text-white text-lg"></i>
                    </div>
                    <div>
                        <h1 class="text-lg font-bold text-white mobile-text-sm">CodeHatch AI</h1>
                        <p class="text-slate-400 text-xs">Universal Assistant</p>
                    </div>
                </div>
                <div class="flex items-center space-x-2">
                    <template x-if="!loggedIn">
                        <span class="text-xs text-orange-400 bg-orange-400/20 px-2 py-1 rounded">Guest</span>
                    </template>
                    <template x-if="loggedIn">
                        <span class="text-xs text-green-400 bg-green-400/20 px-2 py-1 rounded">
                            <i class="fas fa-user-check mr-1"></i>
                            <span x-text="username"></span>
                        </span>
                    </template>
                </div>
            </div>
        </div>

        <!-- Tabs - Mobile Navigation -->
        <div class="bg-slate-800 border-b border-slate-700 p-2 mobile-padding">
            <div class="flex space-x-1">
                <button 
                    @click="activeTab = 'chat'" 
                    :class="activeTab === 'chat' ? 'mobile-tab active text-white border-blue-500' : 'mobile-tab text-slate-400 border-transparent'"
                    class="flex-1 py-2 px-2 rounded-lg border text-sm font-medium transition mobile-text-sm"
                >
                    <i class="fas fa-comments mr-1"></i> Chat
                </button>
                <button 
                    @click="activeTab = 'history'" 
                    :class="activeTab === 'history' ? 'mobile-tab active text-white border-blue-500' : 'mobile-tab text-slate-400 border-transparent'"
                    class="flex-1 py-2 px-2 rounded-lg border text-sm font-medium transition mobile-text-sm"
                >
                    <i class="fas fa-history mr-1"></i> History
                </button>
                <button 
                    @click="activeTab = 'login'" 
                    :class="activeTab === 'login' ? 'mobile-tab active text-white border-blue-500' : 'mobile-tab text-slate-400 border-transparent'"
                    class="flex-1 py-2 px-2 rounded-lg border text-sm font-medium transition mobile-text-sm"
                >
                    <i class="fas fa-user mr-1"></i> Account
                </button>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="flex-1 overflow-hidden">
            <!-- Chat Tab -->
            <template x-if="activeTab === 'chat'">
                <div class="h-full flex flex-col">
                    <!-- Messages Area -->
                    <div id="messages" class="messages-container flex-1 overflow-y-auto p-3 space-y-3 mobile-padding">
                        <!-- Welcome Message -->
                        <div class="message-ai">
                            <div class="flex items-start space-x-2">
                                <div class="w-8 h-8 bg-gradient-to-r from-green-400 to-blue-500 rounded-full flex items-center justify-center flex-shrink-0">
                                    <i class="fas fa-robot text-white text-xs"></i>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <div class="font-semibold text-blue-300 text-sm mb-1">CodeHatch AI</div>
                                    <div class="text-slate-200 text-sm leading-relaxed">
                                        <p class="mb-2">Hello! I'm your universal AI assistant. I can help you with:</p>
                                        <ul class="list-disc list-inside space-y-1 text-slate-300 text-xs">
                                            <li>Answering questions on any topic</li>
                                            <li>Writing and content creation</li>
                                            <li>Problem solving and explanations</li>
                                            <li>Learning and research assistance</li>
                                        </ul>
                                        <p class="mt-2 text-xs">What would you like to know today? 👇</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Actions - Mobile Optimized -->
                    <div class="p-3 border-t border-slate-700 mobile-padding">
                        <div class="grid grid-cols-2 gap-2 mb-3">
                            <button onclick="quickAction('Explain quantum computing')" class="bg-slate-700/50 hover:bg-slate-600 p-2 rounded-lg transition text-xs text-center border border-slate-600">
                                <i class="fas fa-atom text-blue-400 mb-1 block"></i>
                                Science
                            </button>
                            <button onclick="quickAction('Write a poem about nature')" class="bg-slate-700/50 hover:bg-slate-600 p-2 rounded-lg transition text-xs text-center border border-slate-600">
                                <i class="fas fa-pen text-green-400 mb-1 block"></i>
                                Writing
                            </button>
                            <button onclick="quickAction('What is the capital of Japan?')" class="bg-slate-700/50 hover:bg-slate-600 p-2 rounded-lg transition text-xs text-center border border-slate-600">
                                <i class="fas fa-globe text-orange-400 mb-1 block"></i>
                                Geography
                            </button>
                            <button onclick="quickAction('How to improve productivity?')" class="bg-slate-700/50 hover:bg-slate-600 p-2 rounded-lg transition text-xs text-center border border-slate-600">
                                <i class="fas fa-lightbulb text-yellow-400 mb-1 block"></i>
                                Advice
                            </button>
                        </div>

                        <!-- Input Area -->
                        <div class="flex space-x-2">
                            <div class="flex-1 relative">
                                <input 
                                    type="text" 
                                    id="messageInput"
                                    placeholder="Ask me anything..."
                                    class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 mobile-input focus:outline-none focus:border-blue-500 text-sm"
                                    onkeypress="handleKeyPress(event)"
                                >
                                <button onclick="sendMessage()" class="absolute right-2 top-1/2 transform -translate-y-1/2 w-8 h-8 bg-gradient-to-r from-blue-500 to-purple-600 rounded-lg flex items-center justify-center hover:scale-110 transition">
                                    <i class="fas fa-paper-plane text-white text-xs"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </template>

            <!-- History Tab -->
            <template x-if="activeTab === 'history'">
                <div class="h-full p-4 mobile-padding">
                    <template x-if="!$data.loggedIn">
                        <div class="text-center h-full flex flex-col items-center justify-center">
                            <i class="fas fa-history text-4xl mb-4 text-slate-500"></i>
                            <h3 class="text-lg font-semibold text-slate-300 mb-2">Chat History</h3>
                            <p class="text-slate-400 text-sm mb-4">Login to save and view your chat history</p>
                            <button 
                                @click="$data.activeTab = 'login'" 
                                class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-lg transition font-medium"
                            >
                                <i class="fas fa-sign-in-alt mr-2"></i>Go to Login
                            </button>
                        </div>
                    </template>
                    <template x-if="$data.loggedIn">
                        <div class="space-y-3">
                            <h3 class="text-lg font-semibold text-white mb-4">Your Chat History</h3>
                            <div class="bg-slate-800 rounded-lg p-3 border border-slate-700">
                                <div class="font-medium text-white">Science Questions</div>
                                <div class="text-slate-400 text-sm">Yesterday - 5 messages</div>
                            </div>
                            <div class="bg-slate-800 rounded-lg p-3 border border-slate-700">
                                <div class="font-medium text-white">Writing Assistance</div>
                                <div class="text-slate-400 text-sm">2 days ago - 3 messages</div>
                            </div>
                        </div>
                    </template>
                </div>
            </template>

            <!-- Login/Account Tab -->
            <template x-if="activeTab === 'login'">
                <div class="h-full p-4 mobile-padding">
                    <template x-if="!$data.loggedIn">
                        <div class="text-center h-full flex flex-col justify-center">
                            <div class="w-20 h-20 bg-gradient-to-r from-blue-500 to-purple-600 rounded-2xl flex items-center justify-center mx-auto mb-6">
                                <i class="fas fa-user-lock text-white text-2xl"></i>
                            </div>
                            
                            <h3 class="text-xl font-bold text-white mb-2">Welcome to CodeHatch AI</h3>
                            <p class="text-slate-400 text-sm mb-6">Login to unlock all features</p>

                            <!-- Social Login Buttons -->
                            <div class="space-y-3 mb-4">
                                <button 
                                    onclick="googleLogin()"
                                    class="w-full bg-white hover:bg-gray-100 text-gray-800 font-medium py-3 px-4 rounded-lg border border-gray-300 transition flex items-center justify-center"
                                >
                                    <i class="fab fa-google text-red-500 mr-3"></i>
                                    Continue with Google
                                </button>
                                
                                <button 
                                    onclick="githubLogin()"
                                    class="w-full bg-gray-800 hover:bg-gray-900 text-white font-medium py-3 px-4 rounded-lg border border-gray-700 transition flex items-center justify-center"
                                >
                                    <i class="fab fa-github mr-3"></i>
                                    Continue with GitHub
                                </button>
                            </div>

                            <div class="relative my-6">
                                <div class="absolute inset-0 flex items-center">
                                    <div class="w-full border-t border-slate-600"></div>
                                </div>
                                <div class="relative flex justify-center text-sm">
                                    <span class="px-2 bg-slate-900 text-slate-400">Or continue with email</span>
                                </div>
                            </div>

                            <div class="space-y-4 mb-6">
                                <div>
                                    <label class="block text-sm font-medium text-slate-300 mb-2 text-left">Email</label>
                                    <input type="email" id="emailInput" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-blue-500 mobile-input" placeholder="your@email.com">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-300 mb-2 text-left">Password</label>
                                    <input type="password" id="passwordInput" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-blue-500 mobile-input" placeholder="••••••••">
                                </div>
                            </div>

                            <button 
                                onclick="emailLogin()"
                                class="w-full bg-gradient-to-r from-blue-500 to-purple-600 text-white font-bold py-4 rounded-lg hover:from-blue-600 hover:to-purple-700 transition mb-4"
                            >
                                Sign In
                            </button>

                            <div class="text-center">
                                <button class="text-slate-400 hover:text-white text-sm transition">
                                    Don't have an account? <span class="text-blue-400 hover:text-blue-300" onclick="alert('Use Google/GitHub login or contact admin')">Sign up</span>
                                </button>
                            </div>
                        </div>
                    </template>

                    <template x-if="$data.loggedIn">
                        <div class="space-y-6">
                            <div class="text-center">
                                <div class="w-16 h-16 bg-gradient-to-r from-green-400 to-blue-500 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <i class="fas fa-user-check text-white text-xl"></i>
                                </div>
                                <h3 class="text-xl font-bold text-white" x-text="$data.username"></h3>
                                <p class="text-slate-400 text-sm mt-1" x-text="$data.userEmail"></p>
                                <p class="text-green-400 text-sm mt-2">✓ Logged In</p>
                            </div>

                            <div class="space-y-3">
                                <div class="bg-slate-800 rounded-lg p-4 border border-slate-700">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <div class="font-medium text-white">Account Type</div>
                                            <div class="text-slate-400 text-sm">Free Plan</div>
                                        </div>
                                        <i class="fas fa-crown text-yellow-400"></i>
                                    </div>
                                </div>

                                <div class="bg-slate-800 rounded-lg p-4 border border-slate-700">
                                    <div class="font-medium text-white mb-2">Usage Stats</div>
                                    <div class="text-slate-400 text-sm space-y-1">
                                        <div class="flex justify-between">
                                            <span>Chats Today:</span>
                                            <span>12</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>Questions Asked:</span>
                                            <span>24</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <button 
                                onclick="logout()"
                                class="w-full bg-red-500/20 hover:bg-red-500/30 text-red-400 border border-red-500/30 py-3 rounded-lg transition font-medium"
                            >
                                <i class="fas fa-sign-out-alt mr-2"></i>Logout
                            </button>
                        </div>
                    </template>
                </div>
            </template>
        </div>
    </div>

    <script>
        // Chat memory - yeh previous conversations remember karega
        let chatMemory = [];
        let currentConversationContext = '';

        // Supabase initialization
        let supabase;

        function initSupabase() {
            try {
                const supabaseUrl = 'https://dpkhytntovdupyppkgdc.supabase.co';
                const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRwa2h5dG50b3ZkdXB5cHBrZ2RjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwNTE5NjQsImV4cCI6MjA3MzYyNzk2NH0.nBVRjzj7izsPP3rDt8p7UDclkuHYw4vPSYZ92LkfzHg';
                
                if (typeof window.supabase !== 'undefined') {
                    supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
                    console.log('✅ Supabase initialized successfully');
                    checkAuthState();
                } else {
                    console.log('⏳ Waiting for Supabase CDN to load...');
                    setTimeout(initSupabase, 100);
                }
            } catch (error) {
                console.error('❌ Supabase init error:', error);
            }
        }

        // Check auth state on page load
        async function checkAuthState() {
            try {
                if (!supabase) {
                    console.log('Supabase not ready yet');
                    return;
                }
                const { data: { session } } = await supabase.auth.getSession();
                if (session) {
                    updateUI(session.user);
                }
            } catch (error) {
                console.error('Auth check error:', error);
            }
        }

        // Google Login
        async function googleLogin() {
            try {
                if (!supabase) {
                    alert('Please wait, app is still loading...');
                    return;
                }
                
                console.log('🚀 Starting Google login...');
                const { data, error } = await supabase.auth.signInWithOAuth({
                    provider: 'google',
                    options: {
                        redirectTo: 'https://devnest-ai.vercel.app'
                    }
                });
                if (error) throw error;
                console.log('✅ Google login initiated');
            } catch (error) {
                console.error('Google login error:', error);
                alert('Google login failed: ' + error.message);
            }
        }

        // GitHub Login
        async function githubLogin() {
            try {
                if (!supabase) {
                    alert('Please wait, app is still loading...');
                    return;
                }
                
                console.log('🚀 Starting GitHub login...');
                const { data, error } = await supabase.auth.signInWithOAuth({
                    provider: 'github',
                    options: {
                        redirectTo: 'https://devnest-ai.vercel.app'
                    }
                });
                if (error) throw error;
                console.log('✅ GitHub login initiated');
            } catch (error) {
                console.error('GitHub login error:', error);
                alert('GitHub login failed: ' + error.message);
            }
        }

        // Email Login (Basic)
        async function emailLogin() {
            const email = document.getElementById('emailInput').value;
            const password = document.getElementById('passwordInput').value;
            
            if (!email || !password) {
                alert('Please enter both email and password');
                return;
            }

            try {
                if (!supabase) {
                    alert('Please wait, app is still loading...');
                    return;
                }

                console.log('🚀 Starting email login...');
                const { data, error } = await supabase.auth.signInWithPassword({
                    email: email,
                    password: password
                });
                
                if (error) throw error;
                console.log('✅ Email login successful');
                
            } catch (error) {
                console.error('Email login error:', error);
                alert('Login failed: ' + error.message);
            }
        }

        // Logout
        async function logout() {
            try {
                if (!supabase) return;
                
                const { error } = await supabase.auth.signOut();
                if (error) throw error;
                
                updateUILogout();
                alert('Logged out successfully!');
            } catch (error) {
                console.error('Logout error:', error);
                alert('Logout failed: ' + error.message);
            }
        }

        // Update UI when auth state changes
        function updateUI(user) {
            console.log('🔄 Updating UI for user:', user.email);
            
            try {
                const alpineElement = document.querySelector('[x-data]');
                if (alpineElement && alpineElement.__x) {
                    const alpine = alpineElement.__x;
                    
                    alpine.$data.loggedIn = true;
                    alpine.$data.username = user.user_metadata?.name || user.email.split('@')[0];
                    alpine.$data.userEmail = user.email;
                    alpine.$data.activeTab = 'chat';
                    
                    console.log('✅ Alpine UI Updated:', alpine.$data.username);
                    
                    Alpine.nextTick(() => {
                        console.log('Alpine reactivity triggered');
                    });
                }
                
                setTimeout(() => {
                    alert(`✅ Login successful! Welcome ${user.user_metadata?.name || user.email}`);
                }, 500);
                
            } catch (error) {
                console.error('UI update error:', error);
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            }
        }

        // Update UI for logout
        function updateUILogout() {
            try {
                const alpineElement = document.querySelector('[x-data]');
                if (alpineElement && alpineElement.__x) {
                    const alpine = alpineElement.__x;
                    
                    alpine.$data.loggedIn = false;
                    alpine.$data.username = 'User';
                    alpine.$data.userEmail = '';
                    alpine.$data.activeTab = 'login';
                    
                    console.log('✅ UI updated for logout');
                    
                    Alpine.nextTick(() => {
                        console.log('Alpine reactivity triggered for logout');
                    });
                }
            } catch (error) {
                console.error('Logout UI update error:', error);
            }
        }

        // Listen for auth state changes
        function setupAuthListener() {
            if (!supabase) {
                setTimeout(setupAuthListener, 100);
                return;
            }
            
            supabase.auth.onAuthStateChange((event, session) => {
                console.log('Auth state changed:', event);
                if (event === 'SIGNED_IN' && session?.user) {
                    updateUI(session.user);
                } else if (event === 'SIGNED_OUT') {
                    updateUILogout();
                }
            });
        }

        // Page load initialization
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Page loaded, initializing Supabase...');
            initSupabase();
            setupAuthListener();
        });

        // Chat functions
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        function quickAction(prompt) {
            document.getElementById('messageInput').value = prompt;
            sendMessage();
        }

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message) return;

            input.value = '';
            addMessage('user', message);
            
            // Chat memory mein add karo
            chatMemory.push({ role: 'user', content: message });
            
            // Context update karo based on current conversation
            updateConversationContext(message);
            
            showTyping();

            try {
                const response = await fetch('https://devnest-ai.onrender.com/api/chat', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ 
                        message: message,
                        userId: 'mobile-user-' + Date.now(),
                        context: currentConversationContext // Context bhejo
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    hideTyping();
                    
                    // Typewriter effect ke saath message show karo
                    const aiResponse = data.response || data.message;
                    chatMemory.push({ role: 'assistant', content: aiResponse });
                    addMessageWithTypewriter('ai', aiResponse);
                } else {
                    throw new Error('Backend unavailable');
                }

            } catch (error) {
                console.log('Backend failed, using smart responses...');
                hideTyping();
                
                const lowerMsg = message.toLowerCase();
                let responseText = generateSmartResponse(lowerMsg, message);
                
                // Chat memory mein add karo
                chatMemory.push({ role: 'assistant', content: responseText });
                
                // Typewriter effect ke saath message show karo
                addMessageWithTypewriter('ai', responseText);
            }
        }

        // Conversation context update karta hai
        function updateConversationContext(newMessage) {
            const lowerMsg = newMessage.toLowerCase();
            
            // Agar naya topic start ho raha hai
            if (chatMemory.length === 0 || isNewTopic(lowerMsg)) {
                currentConversationContext = extractTopic(newMessage);
            }
            
            // Last 3 messages se context build karo
            const recentMessages = chatMemory.slice(-3).map(msg => msg.content).join(' ');
            if (recentMessages.length > 0) {
                currentConversationContext = recentMessages;
            }
        }

        // Check if user is starting a new topic
        function isNewTopic(message) {
            const newTopicIndicators = [
                'what is', 'explain', 'tell me about', 'how to', 'why is',
                'can you', 'could you', 'i want to know about'
            ];
            
            return newTopicIndicators.some(indicator => message.includes(indicator));
        }

        // Extract main topic from message
        function extractTopic(message) {
            // Simple topic extraction
            const words = message.toLowerCase().split(' ');
            const stopWords = ['what', 'is', 'the', 'a', 'an', 'how', 'to', 'do', 'you', 'can', 'could', 'explain', 'tell', 'me', 'about'];
            
            const topicWords = words.filter(word => 
                !stopWords.includes(word) && word.length > 3
            );
            
            return topicWords.join(' ') || message.substring(0, 30);
        }

        // SMART RESPONSE GENERATOR WITH CONTEXT AWARENESS
        function generateSmartResponse(lowerMsg, originalMsg) {
            // Previous context check karo
            const hasPreviousContext = chatMemory.length > 2;
            const lastUserMessage = hasPreviousContext ? chatMemory[chatMemory.length - 2].content : '';
            
            // Context-aware responses
            if (hasPreviousContext) {
                // Agar previous conversation related hai
                if (lowerMsg.includes('more') || lowerMsg.includes('detail') || lowerMsg.includes('explain')) {
                    return getDetailedResponse(lastUserMessage, lowerMsg);
                }
                else if (lowerMsg.includes('example') || lowerMsg.includes('example')) {
                    return getExampleResponse(lastUserMessage);
                }
            }

            // Science & Technology
            if (lowerMsg.includes('quantum') || lowerMsg.includes('physics')) {
                return `Quantum computing leverages quantum mechanics to process information. Unlike classical bits (0 or 1), quantum bits (qubits) can exist in multiple states simultaneously through superposition. This allows quantum computers to solve certain problems much faster than traditional computers.`;
            }
            else if (lowerMsg.includes('ai') || lowerMsg.includes('artificial intelligence')) {
                return `Artificial Intelligence (AI) refers to computer systems that can perform tasks typically requiring human intelligence. This includes machine learning, natural language processing, computer vision, and robotics.`;
            }
            else if (lowerMsg.includes('programming') || lowerMsg.includes('coding')) {
                return `Programming involves writing instructions for computers to execute. Popular languages include Python for data science, JavaScript for web development, and Java for enterprise applications.`;
            }

            // Geography
            else if (lowerMsg.includes('japan') || lowerMsg.includes('tokyo')) {
                return `Tokyo is the capital of Japan, with over 37 million people in its metropolitan area. It's a global hub for technology and culture. Japan is known for its rich history and advanced technology.`;
            }
            else if (lowerMsg.includes('india') || lowerMsg.includes('delhi')) {
                return `India is the world's largest democracy. New Delhi is its capital, while Mumbai is the financial hub. India is known for its diverse culture and ancient history.`;
            }

            // Writing & Literature
            else if (lowerMsg.includes('poem') || lowerMsg.includes('poetry')) {
                return `In the quiet of the morning light,\nWhere dreams still linger, soft and bright,\nThe world awakens, fresh and new,\nFilled with promise, pure and true.`;
            }

            // Default context-aware response
            else {
                if (hasPreviousContext) {
                    return `Based on our previous discussion about "${lastUserMessage.substring(0, 50)}...", I understand you're asking about "${originalMsg}". ${getContextualResponse(lastUserMessage, originalMsg)}`;
                } else {
                    return `I understand you're asking about "${originalMsg}". That's an interesting topic! Could you provide more specific details about what you'd like to know?`;
                }
            }
        }

        // Contextual responses for follow-up questions
        function getContextualResponse(previousMessage, currentMessage) {
            const prevLower = previousMessage.toLowerCase();
            const currLower = currentMessage.toLowerCase();
            
            if (prevLower.includes('quantum') && currLower.includes('work')) {
                return `Quantum computers work by using qubits that can represent multiple states simultaneously through superposition and can be entangled with each other, allowing for parallel computation on a massive scale.`;
            }
            else if (prevLower.includes('programming') && currLower.includes('learn')) {
                return `To start learning programming, I'd recommend beginning with Python as it has simple syntax and is versatile. Practice with small projects and gradually build up to more complex applications.`;
            }
            else if (prevLower.includes('japan') && currLower.includes('culture')) {
                return `Japanese culture is rich with traditions like tea ceremony, martial arts, and festivals. Modern Japanese culture also includes anime, manga, and advanced technology integration.`;
            }
            
            return `I'd be happy to provide more information about this. What specific aspect are you most interested in?`;
        }

        function getDetailedResponse(topic, query) {
            return `Let me provide more detailed information about ${topic}:\n\n${getAdditionalDetails(topic)}`;
        }

        function getExampleResponse(topic) {
            return `Here's an example related to ${topic}:\n\n${getPracticalExample(topic)}`;
        }

        function getAdditionalDetails(topic) {
            if (topic.includes('quantum')) {
                return `Additional details about quantum computing:\n• Uses principles like superposition and entanglement\n• Potential applications in cryptography and drug discovery\n• Major companies working on it include Google, IBM, and Microsoft\n• Still in experimental stages but advancing rapidly`;
            }
            return `I can provide more in-depth information about this topic. What specific area would you like me to focus on?`;
        }

        function getPracticalExample(topic) {
            if (topic.includes('programming')) {
                return `Example: Simple Python function\n\`\`\`python\ndef greet(name):\n    return f"Hello, {name}!"\n\nprint(greet("Alice"))\n# Output: Hello, Alice!\n\`\`\``;
            }
            return `Here's a practical example related to your query. Would you like me to elaborate further?`;
        }

        // Normal message without typewriter
        function addMessage(sender, text) {
            const container = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            
            messageDiv.className = sender === 'user' ? 'message-user' : 'message-ai';
            messageDiv.innerHTML = `
                <div class="flex items-start space-x-2">
                    <div class="w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0 ${
                        sender === 'user' ? 'bg-gradient-to-r from-purple-500 to-pink-500' : 'bg-gradient-to-r from-green-400 to-blue-500'
                    }">
                        <i class="fas ${sender === 'user' ? 'fa-user' : 'fa-robot'} text-white text-xs"></i>
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="font-semibold mb-1 ${sender === 'user' ? 'text-purple-300' : 'text-blue-300'} text-sm">${sender === 'user' ? 'You' : 'CodeHatch AI'}</div>
                        <div class="text-slate-200 leading-relaxed whitespace-pre-wrap text-sm">${formatMessage(text)}</div>
                    </div>
                </div>
            `;
            
            container.appendChild(messageDiv);
            scrollToBottom();
        }

        // Message with typewriter effect
        function addMessageWithTypewriter(sender, text) {
            const container = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            
            messageDiv.className = sender === 'user' ? 'message-user' : 'message-ai';
            messageDiv.innerHTML = `
                <div class="flex items-start space-x-2">
                    <div class="w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0 ${
                        sender === 'user' ? 'bg-gradient-to-r from-purple-500 to-pink-500' : 'bg-gradient-to-r from-green-400 to-blue-500'
                    }">
                        <i class="fas ${sender === 'user' ? 'fa-user' : 'fa-robot'} text-white text-xs"></i>
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="font-semibold mb-1 ${sender === 'user' ? 'text-purple-300' : 'text-blue-300'} text-sm">${sender === 'user' ? 'You' : 'CodeHatch AI'}</div>
                        <div id="typewriter-${Date.now()}" class="text-slate-200 leading-relaxed text-sm typewriter"></div>
                    </div>
                </div>
            `;
            
            container.appendChild(messageDiv);
            scrollToBottom();
            
            // Typewriter effect
            const typewriterElement = document.getElementById(`typewriter-${Date.now()}`);
            typeText(typewriterElement, text, 20);
        }

        // Typewriter effect function with AUTO SCROLL
        function typeText(element, text, speed = 30) {
            let i = 0;
            element.innerHTML = '';
            
            function type() {
                if (i < text.length) {
                    // Format code blocks properly
                    if (text.substring(i, i + 3) === '```') {
                        const codeBlockEnd = text.indexOf('```', i + 3);
                        if (codeBlockEnd !== -1) {
                            const codeContent = text.substring(i, codeBlockEnd + 3);
                            element.innerHTML = formatMessage(text.substring(0, codeBlockEnd + 3));
                            i = codeBlockEnd + 3;
                        }
                    }
                    
                    const currentText = text.substring(0, i + 1);
                    element.innerHTML = formatMessage(currentText);
                    i++;
                    
                    // HAR CHARACTER TYPE HONE KE BAAD SCROLL KARO
                    scrollToBottom();
                    setTimeout(type, speed);
                } else {
                    // Typewriter complete - remove cursor
                    element.classList.remove('typewriter');
                    // Final scroll
                    scrollToBottom();
                }
            }
            
            type();
        }

        function formatMessage(content) {
            return content
                .replace(/\`\`\`([^]+?)\`\`\`/g, '<div class="bg-slate-900 p-3 my-2 rounded-lg overflow-x-auto border border-slate-600"><code class="whitespace-pre text-xs">$1</code></div>')
                .replace(/\`(.*?)\`/g, '<code class="bg-slate-700 px-1.5 py-0.5 rounded text-xs border border-slate-600">$1</code>')
                .replace(/\n/g, '<br>');
        }

        function showTyping() {
            const container = document.getElementById('messages');
            const typingDiv = document.createElement('div');
            typingDiv.id = 'typingIndicator';
            typingDiv.className = 'message-ai';
            typingDiv.innerHTML = `
                <div class="flex items-start space-x-2">
                    <div class="w-8 h-8 rounded-full flex items-center justify-center bg-gradient-to-r from-green-400 to-blue-500">
                        <i class="fas fa-robot text-white text-xs"></i>
                    </div>
                    <div>
                        <div class="font-semibold text-blue-300 text-sm mb-1">CodeHatch AI</div>
                        <div class="typing-indicator flex space-x-1">
                            <span class="w-1.5 h-1.5 bg-slate-400 rounded-full"></span>
                            <span class="w-1.5 h-1.5 bg-slate-400 rounded-full"></span>
                            <span class="w-1.5 h-1.5 bg-slate-400 rounded-full"></span>
                        </div>
                    </div>
                </div>
            `;
            container.appendChild(typingDiv);
            scrollToBottom();
        }

        function hideTyping() {
            const typing = document.getElementById('typingIndicator');
            if (typing) typing.remove();
        }

        // IMPROVED SCROLL FUNCTION - HAR BAAR BOTTOM PE SCROLL KAREGA
        function scrollToBottom() {
            const container = document.getElementById('messages');
            // Thoda delay karo taki DOM update ho jaye
            setTimeout(() => {
                container.scrollTo({
                    top: container.scrollHeight,
                    behavior: 'smooth'
                });
            }, 10);
        }

        // Auto-focus on input
        setTimeout(() => {
            const input = document.getElementById('messageInput');
            if (input) input.focus();
        }, 1000);
    </script>
</body>
</html>